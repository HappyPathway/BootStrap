{
  "variables": {
    "repo": "",
    "version": "",
    "distro": "trusty",
    "chef_server": "",
    "chef_validation_key": "{{env `CHEF_VALIDATION_KEY` }}",
    "chef_client_name": "{{env `CHEF_CLIENT_NAME` }}",
    "docker_account": "",
    "docker_user": "{{env `DOCKER_USER`}}",
    "docker_passwd": "{{env `DOCKER_PASSWORD`}}",
    "proxy_name": ""
  },
  "builders": [
    {
      "type": "docker",
      "image": "ubuntu:{{user `distro`}}",
      "commit": true,
      "changes": [
        "ENTRYPOINT /etc/nginx/startup.sh"
      ]
    }
  ],
  "provisioners": [
    {
        "type": "shell",
        "inline": [
          "apt-get update",
          "apt-get install -y curl",
          "curl -L https://www.chef.io/chef/install.sh | sudo bash"
        ]
    },
    {
        "type": "chef-client",
        "server_url": "{{user `chef_server`}}",
        "chef_environment": "{{user `env`}}",
        "run_list": "role[{{user `role`}}]",
        "ssl_verify_mode": "verify_none",
        "validation_key_path": "{{user `chef_validation_key` }}",
        "validation_client_name": "{{user `chef_client_name` }}",
        "json": {
          "proxy_name": "{{user `proxy_name` }}"
        }
    },
    {
        "type": "shell",
        "inline": [
          "/usr/sbin/nginx -t -c /etc/nginx/nginx.conf"
        ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `docker_account` }}/{{user `repo`}}",
        "tag": "{{user `version`}}"
      },
      {
        "type": "docker-push",
        "login": true,
        "login_username": "{{user `docker_user`}}",
        "login_password": "{{user `docker_passwd`}}"
      }
    ]
  ]
}
